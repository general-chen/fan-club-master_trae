# 风扇阵列通信故障修复总结报告

**日期**: 2026-01-19  
**项目**: Fan Club Master Control System (Trae Version)  
**问题描述**: Master 程序无法发现或连接 21x21 风扇阵列中的任何风扇，日志全屏报错 `socket_timeout`。

---

## 1. 问题根源分析

经过从物理层到应用层的全面排查，确定导致连接失败的根本原因是一个**多重因素叠加的网络配置与代码逻辑不匹配**问题：

1.  **物理网络拓扑不匹配**:
    *   **现状**: 电脑有两个网卡，一个是连接外网/WiFi的 `10.x.x.x` 网段，另一个是连接风扇交换机的 `192.168.0.10` 有线网卡。
    *   **故障**: 代码默认绑定 `0.0.0.0`（自动选择），导致 Windows 经常错误地使用 WiFi 网卡发送广播包。风扇收到的广播包源地址是 `10.x.x.x`，无法回复。

2.  **端口随机性与防火墙拦截**:
    *   **现状**: Master 的监听端口是系统随机分配的（如 `63169`）。
    *   **故障**: 风扇向这个随机高位端口回复握手包时，极易被 Windows 防火墙当作“未经请求的入站流量”拦截，即使已经放行了 Python 程序。

3.  **缓冲区溢出**:
    *   **故障**: `FCCommunicator` 中接收握手包的缓冲区被硬编码为 **256 字节**。如果风扇返回的数据包稍长（包含调试信息或版本号），就会被截断，导致解析失败。

4.  **IP 配置冲突**:
    *   **故障**: 配置文件 `profiles.py` 中存在重复且无效的 IP 设置，覆盖了正确的配置。

---

## 2. 修复实施步骤

### 2.1 网络层修复：强制绑定专用网卡
修改了 `FCCommunicator.py` 和 `external.py`，强制所有网络通信绑定到连接风扇的专用 IP `192.168.0.10`。

*   **广播 (Broadcast)**: 锁定源 IP 为 `192.168.0.10`。
*   **监听 (Listener)**: 锁定绑定 IP 为 `192.168.0.10`。
*   **单点通信 (MISO/MOSI)**: 所有 21 个风扇的独立通信线程全部锁定绑定 IP 为 `192.168.0.10`。
*   **外部控制 (External)**: 修复了外部控制接口默认绑定 `0.0.0.0` 的隐患。

### 2.2 传输层修复：固定监听端口
为了彻底解决防火墙拦截和端口协商问题，废弃了随机端口机制。

*   **修改前**: `self.listenerSocket.bind((self.defaultIPAddress, 0))` (随机端口)
*   **修改后**: `self.listenerSocket.bind((self.defaultIPAddress, 57584))` (固定端口)

### 2.3 应用层修复：扩大缓冲区
修复了潜在的数据包截断问题。

*   **修改前**: `recvfrom(256)`
*   **修改后**: `recvfrom(self.maxLength)` (通常为 1024 字节)

### 2.4 配置层修复：清理与优化
*   **配置文件**: 清理 `profiles.py` 中的重复项，确保 `ARRAY_21X21` 配置块生效。
*   **稳定性**: 将通信周期 `ac.periodMS` 从 `50ms` 调整为 `100ms`，以减轻 Windows 系统负载，减少超时。

### 2.5 系统层操作
*   **防火墙**: 添加了 PowerShell 规则，显式放行 Python 解释器的所有入站流量。

---

## 3. 最终状态确认

1.  **交换机数据**: 确认广播包已成功发送且流量均衡。
2.  **Master 日志**: 
    *   不再出现 `socket_timeout in receive`（完全收不到包）。
    *   出现了 `Slave timed out`，证明**握手已成功**，Master 已经“看见”了风扇，只是偶尔因网络延迟超时。
    *   日志显示监听端口已成功固定在 `57584`。

## 4. 后续建议

*   **MAC 地址映射**: 目前风扇可能显示为“新设备”（Index 21+）。建议在 GUI 中确认风扇的实际 MAC 地址后，更新到 `profiles.py` 中，以便自动映射到正确的物理位置（Row 0 - Row 20）。
*   **性能监控**: 如果需要更低延迟（50ms），建议将 Master 运行在 Linux 环境下，或确保 Windows 电脑关闭不必要的后台进程。
